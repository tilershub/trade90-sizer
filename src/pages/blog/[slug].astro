---
import BaseLayout from "../../layouts/BaseLayout.astro";
import FAQ from "../../components/FAQ.astro";
import BlogCard from "../../components/BlogCard.astro";
import { ghostClient } from "../../lib/ghost";

export async function getStaticPaths() {
  const posts = await ghostClient.posts.browse({ limit: "all", include: "tags" });
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

const site = Astro.site?.toString() || "https://tradeninety.com";
const assetOrigin = "https://trade90.ghost.io";

// --------- Clean image + html ----------
const cleanFeatureImage = post.feature_image?.startsWith("http")
  ? post.feature_image.replace(/https:\/\/(www\.)?tradeninety\.com/, assetOrigin)
  : post.feature_image
    ? `${assetOrigin}${post.feature_image}`
    : undefined;

const cleanHtml =
  post.html
    ?.replaceAll('src="/content/images/', `src="${assetOrigin}/content/images/`)
    .replaceAll(
      /https:\/\/(www\.)?tradeninety\.com\/content\/images\//g,
      `${assetOrigin}/content/images/`
    );

// --------- Related posts ----------
const relatedPosts = await ghostClient.posts
  .browse({
    filter: `tag:${post.primary_tag?.slug}+id:-${post.id}`,
    limit: 3,
    include: "tags",
  })
  .catch(() => []);

// --------- URLs + dates ----------
const canonicalURL = new URL(`/blog/${post.slug}/`, site).toString();

// OG image URL: handle absolute Ghost URLs correctly
const ogImageRaw = cleanFeatureImage || "/og-image.jpg";
const ogImageURL = ogImageRaw.startsWith("http")
  ? ogImageRaw
  : new URL(ogImageRaw, site).toString();

const publishedISO = post.published_at ? new Date(post.published_at).toISOString() : undefined;
const modifiedISO = post.updated_at ? new Date(post.updated_at).toISOString() : publishedISO;

// --------- Keywords / section ----------
const tagNames = (post.tags || []).map((t) => t.name).filter(Boolean);
const keywords = tagNames.slice(0, 12);
const primarySection = post.primary_tag?.name || "Market Analysis";

// --------- Word count (helps article richness) ----------
const wordCount = post.html
  ? post.html.replace(/<[^>]*>/g, " ").trim().split(/\s+/).filter(Boolean).length
  : undefined;

// ✅ IMPORTANT: BaseLayout already outputs Article schema when articlePublishedTime exists.
// So here we ONLY output Breadcrumb schema (and optional extras) to avoid duplicates.
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: `${site}/` },
    { "@type": "ListItem", position: 2, name: "Blog", item: `${site}/blog/` },
    { "@type": "ListItem", position: 3, name: post.title, item: canonicalURL },
  ],
};

// Optional: Tell Google your page is a “ReadAction”
const webPageActionsSchema = {
  "@context": "https://schema.org",
  "@type": "WebPage",
  "@id": canonicalURL,
  potentialAction: {
    "@type": "ReadAction",
    target: [canonicalURL],
  },
};
---

<BaseLayout
  title={post.title}
  description={post.excerpt}
  ogImage={ogImageRaw.startsWith("http") ? ogImageRaw : ogImageRaw}
  articlePublishedTime={publishedISO}
  articleModifiedTime={modifiedISO}
>
  <!-- ✅ Breadcrumbs (good for SERP) -->
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)}></script>

  <!-- ✅ Optional: ReadAction -->
  <script type="application/ld+json" set:html={JSON.stringify(webPageActionsSchema)}></script>

  <article class="max-w-3xl mx-auto py-16 px-6">
    <header class="mb-16">
      <time class="text-[10px] text-emerald-500 font-black uppercase tracking-[0.4em] mb-6 block">
        {new Date(post.published_at).toLocaleDateString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
        })}
      </time>

      <h1 class="text-4xl md:text-6xl font-black mt-2 mb-10 tracking-tighter uppercase text-white leading-[0.9] lg:text-7xl">
        {post.title}
      </h1>

      {post.excerpt && (
        <div class="relative">
          <p class="text-slate-300 text-xl leading-relaxed font-medium border-l-4 border-emerald-500/50 pl-8 py-2 italic">
            {post.excerpt}
          </p>
        </div>
      )}
    </header>

    {cleanFeatureImage && (
      <figure class="mb-16">
        <img
          src={cleanFeatureImage}
          alt={post.title}
          class="rounded-3xl border border-slate-800 w-full shadow-2xl shadow-emerald-900/10"
          loading="lazy"
          decoding="async"
        />
      </figure>
    )}

    <div class="ghost-content selection:bg-emerald-500/30" set:html={cleanHtml} />

    {relatedPosts.length > 0 && (
      <section class="mt-12 border-t border-slate-900/50 pt-12">
        <header class="mb-8">
          <h2 class="text-[10px] font-black uppercase tracking-[0.4em] text-emerald-500 mb-2 border-none p-0 before:hidden">
            Continue Analysis
          </h2>
          <h3 class="text-2xl font-black text-white uppercase tracking-tighter">
            Related Intelligence
          </h3>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          {relatedPosts.map((p) => (
            <BlogCard
              title={p.title}
              excerpt={p.excerpt}
              image={p.feature_image}
              slug={p.slug}
              date={p.published_at}
            />
          ))}
        </div>
      </section>
    )}

    <div class="mt-12 pt-12 border-t border-slate-900/50">
      {/* ✅ FAQ schema only on blog pages */}
      <FAQ showSchema={true} />
    </div>
  </article>

  <style is:global>
    /* keep your existing styles here (unchanged) */
  </style>
</BaseLayout>