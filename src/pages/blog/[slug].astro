---
import BaseLayout from '../../layouts/BaseLayout.astro';
import FAQ from '../../components/FAQ.astro';
import BlogCard from '../../components/BlogCard.astro';
import { ghostClient } from '../../lib/ghost';

export async function getStaticPaths() {
  const posts = await ghostClient.posts.browse({ limit: 'all', include: 'tags' });
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const assetOrigin = "https://trade90.ghost.io";

const relatedPosts = await ghostClient.posts.browse({
  filter: `tag:${post.primary_tag?.slug}+id:-${post.id}`,
  limit: 3,
  include: 'tags'
}).catch(() => []);

const cleanFeatureImage = post.feature_image?.startsWith('http')
  ? post.feature_image.replace(/https:\/\/(www\.)?tradeninety\.com/, assetOrigin)
  : `${assetOrigin}${post.feature_image}`;

const cleanHtml = post.html?.replaceAll('src="/content/images/', `src="${assetOrigin}/content/images/`)
                           .replaceAll(/https:\/\/(www\.)?tradeninety\.com\/content\/images\//g, `${assetOrigin}/content/images/`);
---

<BaseLayout title={post.title} description={post.excerpt}>
  <article class="max-w-3xl mx-auto py-16 px-6">
    <header class="mb-16">
      <time class="text-[10px] text-emerald-500 font-black uppercase tracking-[0.4em] mb-6 block">
        {new Date(post.published_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
      </time>
      
      <h1 class="text-4xl md:text-6xl font-black mt-2 mb-10 tracking-tighter uppercase text-white leading-[0.9] lg:text-7xl">
        {post.title}
      </h1>
      
      {post.excerpt && (
        <div class="relative">
          <p class="text-slate-300 text-xl leading-relaxed font-medium border-l-4 border-emerald-500/50 pl-8 py-2 italic">
            {post.excerpt}
          </p>
        </div>
      )}
    </header>

    {post.feature_image && (
      <figure class="mb-16">
        <img src={cleanFeatureImage} alt={post.title} class="rounded-3xl border border-slate-800 w-full shadow-2xl shadow-emerald-900/10" />
      </figure>
    )}

    <div class="ghost-content selection:bg-emerald-500/30" set:html={cleanHtml} />

    {relatedPosts.length > 0 && (
      <section class="mt-12 border-t border-slate-900/50 pt-12">
        <header class="mb-8">
          <h2 class="text-[10px] font-black uppercase tracking-[0.4em] text-emerald-500 mb-2 border-none p-0 before:hidden">
            Continue Analysis
          </h2>
          <h3 class="text-2xl font-black text-white uppercase tracking-tighter">
            Related Intelligence
          </h3>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          {relatedPosts.map((p) => (
            <BlogCard title={p.title} excerpt={p.excerpt} image={p.feature_image} slug={p.slug} date={p.published_at} />
          ))}
        </div>
      </section>
    )}

    <div class="mt-12 pt-12 border-t border-slate-900/50">
      <FAQ />
    </div>
  </article>
</BaseLayout>

<style is:global>
  .ghost-content {
    @apply text-slate-400 text-[17px] md:text-[18px] leading-[1.85] font-normal;
  }

  /* FIX: Ensure the final paragraph doesn't add extra bottom margin */
  .ghost-content p:last-child {
    @apply mb-0;
  }

  .ghost-content h2 { 
    @apply text-3xl md:text-4xl font-black text-white mt-16 mb-8 uppercase tracking-tighter leading-tight pt-4 border-t border-slate-900; 
  }

  .ghost-content h2::before {
    content: '';
    @apply block w-12 h-1.5 bg-emerald-500 mb-6;
  }

  .ghost-content h3 { @apply text-xl font-black text-slate-100 mt-10 mb-6 uppercase tracking-tight; }
  .ghost-content p { @apply mb-8; }
  .ghost-content ul, .ghost-content ol { @apply mb-10 space-y-4 pl-6; }
  .ghost-content li { @apply relative pl-2; }
  .ghost-content ul li::marker { @apply text-emerald-500 content-['â–¹']; }

  .ghost-content img { @apply rounded-2xl border border-slate-800 my-10 shadow-xl; }

  .ghost-content blockquote {
    @apply border-l-4 border-emerald-500 bg-slate-900/50 py-8 px-10 my-10 italic text-slate-200 text-xl rounded-r-2xl;
  }

  .ghost-content a { @apply text-emerald-400 font-bold underline decoration-emerald-500/20 underline-offset-4 hover:decoration-emerald-500 transition-all; }
</style>
