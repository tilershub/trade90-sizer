---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

const {
  title,
  description = "Professional trading tools and risk management analysis.",
  ogImage = "/og-image.jpg",
  noIndex = false,
  articlePublishedTime,
  articleModifiedTime,
  // optional extras for blog CTR/SEO
  keywords = [],          // array of strings
  breadcrumbName,         // custom breadcrumb last item name (defaults to title)
} = Astro.props;

const site = Astro.site?.toString() || "https://tradeninety.com";

// Canonical URL (always absolute)
const canonicalURL = new URL(Astro.url.pathname, site).toString();

// Absolute URL for OG image
const ogImageURL = new URL(ogImage, site).toString();

// ISO dates for schema (if provided)
const publishedISO = articlePublishedTime ? new Date(articlePublishedTime).toISOString() : undefined;
const modifiedISO = articleModifiedTime
  ? new Date(articleModifiedTime).toISOString()
  : publishedISO;

// Organization schema base
const org = {
  "@type": "Organization",
  name: "TRADE90",
  logo: {
    "@type": "ImageObject",
    url: new URL("/logo.png", site).toString(),
  },
};

// WebSite schema (default)
const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  name: "TRADE90",
  url: site,
  description,
  publisher: org,
};

// BlogPosting schema (only for articles)
const blogPostingSchema = articlePublishedTime
  ? {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      mainEntityOfPage: { "@type": "WebPage", "@id": canonicalURL },
      headline: title,
      description,
      image: [ogImageURL],
      datePublished: publishedISO,
      dateModified: modifiedISO,
      inLanguage: "en",
      isAccessibleForFree: true,
      author: org, // you can swap to Person if you later add author data
      publisher: org,
      ...(Array.isArray(keywords) && keywords.length
        ? { keywords: keywords.slice(0, 10).join(", ") }
        : {}),
    }
  : null;

// Breadcrumb schema (helps CTR sometimes)
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: `${site}/` },
    { "@type": "ListItem", position: 2, name: "Blog", item: `${site}/blog/` },
    { "@type": "ListItem", position: 3, name: breadcrumbName || title, item: canonicalURL },
  ],
};
---

<!DOCTYPE html>
<html lang="en" class="bg-black text-white scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Primary Meta Tags -->
    <title>{title} | TRADE90</title>
    <meta name="title" content={`${title} | TRADE90`} />
    <meta name="description" content={description} />
    {Array.isArray(keywords) && keywords.length ? (
      <meta name="keywords" content={keywords.slice(0, 10).join(", ")} />
    ) : null}
    {noIndex ? <meta name="robots" content="noindex, nofollow" /> : null}
    <link rel="canonical" href={canonicalURL} />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <!-- Open Graph -->
    <meta property="og:type" content={articlePublishedTime ? "article" : "website"} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={`${title} | TRADE90`} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImageURL} />
    <meta property="og:site_name" content="TRADE90" />
    {publishedISO ? <meta property="article:published_time" content={publishedISO} /> : null}
    {modifiedISO ? <meta property="article:modified_time" content={modifiedISO} /> : null}

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalURL} />
    <meta name="twitter:title" content={`${title} | TRADE90`} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageURL} />

    <!-- Performance optimizations -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="anonymous" />
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />

    <!-- Theme color -->
    <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)" />
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)" />

    <!-- Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify(websiteSchema)}></script>
    {blogPostingSchema ? (
      <script type="application/ld+json" set:html={JSON.stringify(blogPostingSchema)}></script>
    ) : null}
    {articlePublishedTime ? (
      <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)}></script>
    ) : null}

    <!-- Google Analytics (replace ID) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XXXXXXXXXX', {
        anonymize_ip: true,
        cookie_flags: 'SameSite=None;Secure'
      });
    </script>
  </head>

  <body class="min-h-screen bg-slate-900 flex flex-col selection:bg-emerald-500/30 antialiased">
    <!-- Skip link -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-emerald-500 focus:text-white focus:rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-400"
    >
      Skip to main content
    </a>

    <Header />

    <main id="main-content" class="flex-grow" role="main">
      <slot />
    </main>

    <Footer />

    <!-- Cookie Banner -->
    <div
      id="cookie-banner"
      class="fixed bottom-0 left-0 right-0 bg-slate-800 border-t border-slate-700 p-4 z-50 hidden"
      role="alertdialog"
      aria-labelledby="cookie-banner-title"
      aria-describedby="cookie-banner-description"
    >
      <div class="max-w-7xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-4">
        <div class="text-sm text-slate-300">
          <span id="cookie-banner-title" class="sr-only">Cookie Consent</span>
          <p id="cookie-banner-description">
            We use cookies to enhance your experience. By continuing you agree to our use of cookies.
            <a href="/privacy" class="text-emerald-400 hover:text-emerald-300 underline ml-1">Learn more</a>
          </p>
        </div>

        <div class="flex gap-3">
          <button
            id="accept-cookies"
            class="px-4 py-2 bg-emerald-500 text-white rounded-md hover:bg-emerald-600 transition-colors text-sm font-medium"
            type="button"
          >
            Accept
          </button>
          <button
            id="decline-cookies"
            class="px-4 py-2 bg-slate-700 text-white rounded-md hover:bg-slate-600 transition-colors text-sm font-medium"
            type="button"
          >
            Decline
          </button>
        </div>
      </div>
    </div>

    <script is:inline>
      (function () {
        const banner = document.getElementById('cookie-banner');
        const acceptBtn = document.getElementById('accept-cookies');
        const declineBtn = document.getElementById('decline-cookies');

        const consent = localStorage.getItem('cookieConsent');
        if (!consent) banner?.classList.remove('hidden');

        acceptBtn?.addEventListener('click', function () {
          localStorage.setItem('cookieConsent', 'accepted');
          banner?.classList.add('hidden');
        });

        declineBtn?.addEventListener('click', function () {
          localStorage.setItem('cookieConsent', 'declined');
          banner?.classList.add('hidden');
        });
      })();
    </script>
  </body>
</html>

<style is:global>
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  .sr-only.focus\:not-sr-only:focus {
    position: static;
    width: auto;
    height: auto;
    padding: 0.5rem 1rem;
    margin: 0;
    overflow: visible;
    clip: auto;
    white-space: normal;
  }

  @media (prefers-reduced-motion: reduce) {
    html {
      scroll-behavior: auto;
    }
  }

  html.light {
    background-color: #ffffff;
    color: #0f172a;
  }

  html.light body {
    background-color: #f1f5f9;
  }
</style>