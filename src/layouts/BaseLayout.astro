---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

const {
  title,
  description = "Professional trading tools and risk management analysis.",
  ogImage = "/og-image.jpg",
  noIndex = false,
  articlePublishedTime,
  articleModifiedTime,
  keywords = [],
  breadcrumbName,
} = Astro.props;

const site = Astro.site?.toString() || "https://tradeninety.com";
const canonicalURL = new URL(Astro.url.pathname, site).toString();

const ogImageURL = ogImage?.startsWith("http")
  ? ogImage
  : new URL(ogImage, site).toString();

const publishedISO = articlePublishedTime ? new Date(articlePublishedTime).toISOString() : undefined;
const modifiedISO = articleModifiedTime ? new Date(articleModifiedTime).toISOString() : publishedISO;

const org = {
  "@type": "Organization",
  name: "TRADE90",
  logo: {
    "@type": "ImageObject",
    url: new URL("/logo.png", site).toString(),
  },
};

const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  name: "TRADE90",
  url: site,
  description,
  publisher: org,
};

const blogPostingSchema = articlePublishedTime
  ? {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      mainEntityOfPage: { "@type": "WebPage", "@id": canonicalURL },
      headline: title,
      description,
      image: [ogImageURL],
      datePublished: publishedISO,
      dateModified: modifiedISO,
      inLanguage: "en",
      isAccessibleForFree: true,
      author: org,
      publisher: org,
      ...(Array.isArray(keywords) && keywords.length
        ? { keywords: keywords.slice(0, 10).join(", ") }
        : {}),
    }
  : null;

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: `${site}/` },
    { "@type": "ListItem", position: 2, name: "Blog", item: `${site}/blog/` },
    { "@type": "ListItem", position: 3, name: breadcrumbName || title, item: canonicalURL },
  ],
};
---

<!DOCTYPE html>
<html lang="en" class="bg-black text-white scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>{title} | TRADE90</title>
    <meta name="title" content={`${title} | TRADE90`} />
    <meta name="description" content={description} />
    {Array.isArray(keywords) && keywords.length ? (
      <meta name="keywords" content={keywords.slice(0, 10).join(", ")} />
    ) : null}
    {noIndex ? <meta name="robots" content="noindex, nofollow" /> : null}
    <link rel="canonical" href={canonicalURL} />

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <meta property="og:type" content={articlePublishedTime ? "article" : "website"} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={`${title} | TRADE90`} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImageURL} />
    <meta property="og:site_name" content="TRADE90" />
    {publishedISO ? <meta property="article:published_time" content={publishedISO} /> : null}
    {modifiedISO ? <meta property="article:modified_time" content={modifiedISO} /> : null}

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalURL} />
    <meta name="twitter:title" content={`${title} | TRADE90`} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageURL} />

    <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)" />
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)" />

    <script type="application/ld+json" set:html={JSON.stringify(websiteSchema)}></script>
    {blogPostingSchema ? (
      <script type="application/ld+json" set:html={JSON.stringify(blogPostingSchema)}></script>
    ) : null}
    {articlePublishedTime ? (
      <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)}></script>
    ) : null}

    <!-- Google Analytics 4 (loads only after cookie consent) -->
    <script is:inline>
      (function () {
        const GA_ID = "G-EBLQLRSZZL";

        function loadGA() {
          if (window.__gaLoaded) return;
          window.__gaLoaded = true;

          const s = document.createElement("script");
          s.async = true;
          s.src = "https://www.googletagmanager.com/gtag/js?id=" + GA_ID;
          document.head.appendChild(s);

          window.dataLayer = window.dataLayer || [];
          function gtag() { dataLayer.push(arguments); }
          window.gtag = gtag;
          gtag("js", new Date());
          gtag("config", GA_ID);
        }

        const consent = localStorage.getItem("cookieConsent");
        if (consent === "accepted") loadGA();

        window.addEventListener("cookie-accepted", loadGA);
      })();
    </script>

    <!-- Google Tag Manager (loads only after cookie consent) -->
    <script is:inline>
      (function () {
        const GTM_ID = "GTM-P2C87C84";

        function loadGTM() {
          if (window.__gtmLoaded) return;
          window.__gtmLoaded = true;

          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({ "gtm.start": new Date().getTime(), event: "gtm.js" });

          const f = document.getElementsByTagName("script")[0];
          const j = document.createElement("script");
          j.async = true;
          j.src = "https://www.googletagmanager.com/gtm.js?id=" + GTM_ID;
          f.parentNode.insertBefore(j, f);
        }

        const consent = localStorage.getItem("cookieConsent");
        if (consent === "accepted") loadGTM();

        window.addEventListener("cookie-accepted", loadGTM);
      })();
    </script>
  </head>

  <body class="min-h-screen bg-slate-900 flex flex-col selection:bg-emerald-500/30 antialiased">
    <!-- Google Tag Manager (noscript) - only after consent -->
    <script is:inline>
      (function () {
        const GTM_ID = "GTM-P2C87C84";
        const consent = localStorage.getItem("cookieConsent");
        if (consent !== "accepted") return;

        const ns = document.createElement("noscript");
        ns.innerHTML =
          '<iframe src="https://www.googletagmanager.com/ns.html?id=' +
          GTM_ID +
          '" height="0" width="0" style="display:none;visibility:hidden"></iframe>';

        document.body.prepend(ns);
      })();
    </script>

    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-emerald-500 focus:text-white focus:rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-400"
    >
      Skip to main content
    </a>

    <Header />

    <main id="main-content" class="flex-grow">
      <slot />
    </main>

    <Footer />

    <div
  id="cookie-banner"
  class="fixed bottom-0 left-0 right-0 bg-slate-800 border-t border-slate-700 p-4 z-50 hidden"
  role="dialog"
  aria-modal="true"
  aria-live="polite"
  aria-labelledby="cookie-banner-title"
  aria-describedby="cookie-banner-description"
>
      <div class="max-w-7xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-4">
        <div class="text-sm text-slate-100">
          <span id="cookie-banner-title" class="sr-only">Cookie Consent</span>
          <p id="cookie-banner-description">
            We use cookies to enhance your experience. By continuing you agree to our use of cookies.
            <a
              href="/privacy"
              class="text-emerald-300 hover:text-emerald-200 underline ml-1"
              aria-label="Read the TRADE90 Privacy Policy"
            >
              Privacy Policy
            </a>
          </p>
        </div>

        <div class="flex gap-3">
          <button
            id="accept-cookies"
            class="px-4 py-2 bg-emerald-800 text-white rounded-md hover:bg-emerald-900 transition-colors text-sm font-medium"
            type="button"
          >
            Accept
          </button>
          <button
            id="decline-cookies"
            class="px-4 py-2 bg-slate-700 text-white rounded-md hover:bg-slate-600 transition-colors text-sm font-medium"
            type="button"
          >
            Decline
          </button>
        </div>
      </div>
    </div>

    <script is:inline>
  (function () {
    const banner = document.getElementById("cookie-banner");
    const acceptBtn = document.getElementById("accept-cookies");
    const declineBtn = document.getElementById("decline-cookies");

    const consent = localStorage.getItem("cookieConsent");

    // Show banner + move keyboard focus into the dialog
    if (!consent) {
      banner?.classList.remove("hidden");
      acceptBtn?.focus();
    }

    function hideBanner() {
      banner?.classList.add("hidden");
    }

    acceptBtn?.addEventListener("click", function () {
      localStorage.setItem("cookieConsent", "accepted");
      hideBanner();
      window.dispatchEvent(new Event("cookie-accepted"));
    });

    declineBtn?.addEventListener("click", function () {
      localStorage.setItem("cookieConsent", "declined");
      hideBanner();
    });

    // Allow ESC key to close the banner (accessibility)
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape" && banner && !banner.classList.contains("hidden")) {
        hideBanner();
      }
    });
  })();
</script>
  </body>
</html>

<style is:global>
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: 0;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }

  .sr-only.focus\:not-sr-only:focus {
    position: static;
    width: auto;
    height: auto;
    padding: 0.5rem 1rem;
    margin: 0;
    overflow: visible;
    clip: auto;
    white-space: normal;
  }

  @media (prefers-reduced-motion: reduce) {
    html {
      scroll-behavior: auto;
    }
  }

  html.light {
    background-color: #ffffff;
    color: #0f172a;
  }

  html.light body {
    background-color: #f1f5f9;
  }

  /* ===========================
     ACCESSIBILITY CONTRAST FIX
     =========================== */

  .bg-black .text-slate-300,
  .bg-black .text-slate-400,
  .bg-black .text-slate-500,
  .bg-black .text-slate-600,
  .bg-slate-800 .text-slate-300,
  .bg-slate-800 .text-slate-400,
  .bg-slate-800 .text-slate-500,
  .bg-slate-800 .text-slate-600,
  .bg-slate-900 .text-slate-300,
  .bg-slate-900 .text-slate-400,
  .bg-slate-900 .text-slate-500,
  .bg-slate-900 .text-slate-600 {
    color: #e5e7eb !important; /* slate-200 */
  }

  footer .text-slate-300,
  footer .text-slate-500,
  footer .text-slate-600 {
    color: #e5e7eb !important;
  }

  #cookie-banner .text-slate-300 {
    color: #f1f5f9 !important; /* slate-100 */
  }

  #cookie-banner a,
  footer a {
    color: #86efac !important; /* emerald-300 */
  }
</style>